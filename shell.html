<!DOCTYPE html>
<html charset="utf-8" lang="en">
    <head><title>iconv</title></head>
    <body>
        <label for="inputfile">Choose input file for re-coding with iconv:</label>
        <input type="file" id="inputfile" name="inputfile" />
        <br />
        <label for="inputencoding">-f</label>
        <input type="text" id="inputencoding" name="inputencoding" value="utf-8" />
        <br />
        <label for="outputencoding">-t</label>
        <input type="text" id="outputencoding" name="outputencoding" value="utf-16" />
        <br />
        <button onclick="iconv_onclick()">iconv</button>
        <br />
        <a id="download">Download result</a>

        <script type="text/javascript">
        // https://stackoverflow.com/questions/32912129/providing-stdin-to-an-emscripten-html-program/33119868#33119868
        // https://stackoverflow.com/questions/15980585/how-to-change-emscripten-browser-input-method-from-window-prompt-to-something-mo
        // https://github.com/emscripten-core/emscripten/issues/8231
        
        const fileupload = document.getElementById('inputfile');
        const downloadElement = document.getElementById('download');
        const inputencoding = document.getElementById('inputencoding');
        const outputencoding = document.getElementById('outputencoding');
            
        var Module = 
        {
            thisProgram : '/usr/bin/iconv',
            noInitialRun : true,
            stdin: () => null,
            print: text => console.log(text);
            setStatus: text => console.log(text);
        };

        window.onerror = () => Module.setStatus('Exception thrown, see JavaScript console');

        function iconv(Module, input_uint8_array, input_encoding, output_encoding)
        {
            const input_path = 'input.bin', output_path = 'output.bin';
            //const args = ['-f', inputencoding.value, '-t', outputencoding.value, '-o', output_path, input_path];
            const args = ['--help'];

            Module.FS.writeFile(input_path, input_uint8_array);
            console.log('exit code:', Module.callMain(args));
            
            //const output_uint8_array = Module.FS.readFile(output_path);
            const output_uint8_array = new Uint8Array([1, 2, 3]);
            
            return output_uint8_array;
        }

        function iconv_onclick()
        {
            if(fileupload.files.length == 0)
                return;

            const file = fileupload.files[0];
            const reader = new FileReader();
            reader.onloadend = evt => 
            {
                if (evt.target.readyState == FileReader.DONE)
                {
                    const input_uint8_array = new Uint8Array(reader.result);
                    const output_uint8_array = iconv(Module, input_uint8_array, inputencoding.value, outputencoding.value);
                    const mime = '';
                    download.download = file_path;
                    download.href = URL.createObjectURL(new Blob([output_uint8_array], {type: mime}));
                }
            }
            reader.readAsArrayBuffer(file);
        }
        

        </script>

        {{{ SCRIPT }}}
    </body>
</html>
