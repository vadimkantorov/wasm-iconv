<!DOCTYPE html>
<html charset="utf-8" lang="en">
    <head><title>iconv</title></head>
    <body>
        <label for="inputfile">Input file for text transcoding:</label>
        <input type="file" id="inputfile" name="inputfile" />
        <br />
        <label for="inputencoding">Input   encoding [-f]:</label>
        <select id="inputencodings">
            <option value="UTF-8" selected>UTF-8</option>
            <option value="UTF-16">UTF-16</option>
            <option value="UTF-16LE">UTF-16LE</option>
            <option disabled>--------</option>
        </select>
        <input type="text" id="inputencoding" name="inputencoding" value="UTF-8" />
        <br />
        <label for="outputencoding">Output encoding [-t]:</label>
        <select id="outputencodings">
            <option value="UTF-8">UTF-8</option>
            <option value="UTF-16" selected>UTF-16</option>
            <option value="UTF-16LE">UTF-16LE</option>
            <option disabled>--------</option>
        </select>
        <input type="text" id="outputencoding" name="outputencoding" value="UTF-16" />
        <br />
        <button onclick="iconv_onclick()">Transcode with iconv</button><a id="download">Download result</a>
        <br />
        <textarea id="status" cols="80" rows="30">
        </textarea>

        <script type="text/javascript">
        
        const inputencodings = document.getElementById('inputencodings');
        const outputencodings = document.getElementById('outputencodings');
        const status = document.getElementById('status');
        const fileupload = document.getElementById('inputfile');
        const downloadElement = document.getElementById('download');
        const inputencoding = document.getElementById('inputencoding');
        const outputencoding = document.getElementById('outputencoding');
            
        var Module = 
        {
            thisProgram : '/usr/bin/iconv',
            noInitialRun : true,
            output_stdout_binary : [],
            print: text => console.log(text),
            setStatus: text => console.log(text),
            stdout: ord => Module.output_stdout_binary.push(ord),
            onRuntimeInitialized : () => 
            {
                Module.output_stdout_binary = [];
                const exit_code1 = Module.callMain(['--help']);
                const help = new TextDecoder().decode(new Uint8Array(Module.output_stdout_binary));
                
                Module.output_stdout_binary = [];
                const exit_code2 = Module.callMain(['--list']);
                const list = new TextDecoder().decode(new Uint8Array(Module.output_stdout_binary));

                const encodings = list.split(/[ ,\n]/).sort().filter(enc => enc);
                
                console.log(exit_code1, exit_code2);
                status.value = help;

                for(const enc of encodings)
                {
                    const opt1 = document.createElement("option");
                    opt1.text = enc;
                    opt1.value = enc;
                    const opt2 = document.createElement("option");
                    opt2.text = enc;
                    opt2.value = enc;
                    inputencodings.add(opt1);
                    outputencodings.add(opt2);
                }
            }
        };

        window.onerror = () => Module.setStatus('Exception thrown, see JavaScript console');

        function iconv(Module, input_uint8_array, input_encoding, output_encoding, input_path = 'input.bin')
        {
            const args = ['-f', inputencoding.value, '-t', outputencoding.value, input_path];

            Module.FS.writeFile(input_path, input_uint8_array);
            Module.output_stdout_binary = [];
            const exit_code = Module.callMain(args);
            const output_uint8_array = new Uint8Array(Module.output_stdout_binary);
            
            console.log('exit code:', exit_code);
            
            return output_uint8_array;
        }

        function iconv_onclick()
        {
            if(fileupload.files.length == 0)
                return;

            const file = fileupload.files[0];
            const reader = new FileReader();
            reader.onloadend = evt => 
            {
                if (evt.target.readyState == FileReader.DONE)
                {
                    const input_uint8_array = new Uint8Array(reader.result);
                    const output_uint8_array = iconv(Module, input_uint8_array, inputencoding.value, outputencoding.value);
                    const output_file_name = 'output.txt';
                    const mime = 'text';
                    download.download = output_file_name;
                    download.href = URL.createObjectURL(new Blob([output_uint8_array], {type: mime}));
                    /*
                    const a = document.createElement('a');
                    a.download = file_path;
                    a.href = URL.createObjectURL(new Blob([content], {type: mime}));
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(a.href); }, timeout_millisec);
                    */
                }
            }
            reader.readAsArrayBuffer(file);
        }
        

        </script>

        {{{ SCRIPT }}}
    </body>
</html>
