<!DOCTYPE html>
<html charset="utf-8" lang="en">
    <head><title>iconv</title></head>
    <body>
        <label for="inputfile">Choose input file for re-coding with iconv:</label>
        <input type="file" id="inputfile" name="inputfile" />
        <br />
        <label for="inputencoding">-f</label>
        <input type="text" id="inputencoding" name="inputencoding" value="utf-8" />
        <br />
        <label for="outputencoding">-t</label>
        <input type="text" id="outputencoding" name="outputencoding" value="utf-16" />
        <br />
        <button onclick="onclick()">iconv</button>

        <div id="status">Downloading...</div>
        <textarea id="output" rows="8"></textarea>

        <script type="text/javascript">
        // https://stackoverflow.com/questions/32912129/providing-stdin-to-an-emscripten-html-program/33119868#33119868
        // https://stackoverflow.com/questions/15980585/how-to-change-emscripten-browser-input-method-from-window-prompt-to-something-mo
        // https://github.com/emscripten-core/emscripten/issues/8231
        var statusElement = document.getElementById('status');
  
        var Module = {
          print: (function() {
            var element = document.getElementById('output');
            if (element) element.value = ''; // clear browser cache
            return function(text) {
              if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
              console.log(text);
              if (element) {
                element.value += text + "\n";
                element.scrollTop = element.scrollHeight; // focus on bottom
              }
            };
          })(),
          setStatus: (text) => {
            if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
            if (text === Module.setStatus.last.text) return;
            var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
            var now = Date.now();
            if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
            Module.setStatus.last.time = now;
            Module.setStatus.last.text = text;
            statusElement.innerHTML = text;
          },
          totalDependencies: 0,
          monitorRunDependencies: (left) => {
            this.totalDependencies = Math.max(this.totalDependencies, left);
            Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
          }
        };
        Module.setStatus('Downloading...');
        window.onerror = () => {
          Module.setStatus('Exception thrown, see JavaScript console');
          Module.setStatus = (text) => {
            if (text) console.error('[post-exception status] ' + text);
          };
        };
        
        function onclick()
        {
            const fileupload = document.getElementById('inputfile');
            if(fileupload.files.length == 0)
                return;

            const file = fileupload.files[0];
            const reader = new FileReader();
            reader.onloadend = ev => {
                if (evt.target.readyState == FileReader.DONE)
                {
                    Module.FS.writeFile(dst_path, new Uint8Array(reader.result));
                    resolve(dst_path);
                }
            }
            reader.readAsArrayBuffer(file);
        }

        </script>

        {{{ SCRIPT }}}
    </body>
</html>
